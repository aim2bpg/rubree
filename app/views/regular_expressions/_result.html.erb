<div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-900 rounded-lg shadow-lg p-4 mb-4 border border-gray-700 landscape-2col tablet-2col">
  <%= render partial: "regular_expressions/results/diagram", locals: { regular_expression: regular_expression } %>

  <div
    x-data="{
      wrap: localStorage.getItem('wrap') === 'false' ? false : true,
      showInvisibles: localStorage.getItem('showInvisibles') === 'true',
      init() {
        this.$watch('wrap', value => localStorage.setItem('wrap', value));
        this.$watch('showInvisibles', value => localStorage.setItem('showInvisibles', value));
      }
    }"
    class="flex flex-col space-y-2 overflow-auto rounded border border-gray-700 bg-gray-900 p-4 min-h-[140px] text-white text-left">
    <% if regular_expression.regular_expression.blank? && regular_expression.test_string.blank? %>
      <p class="text-gray-500 m-auto text-center"><%= t("regular_expressions.results.test_result_placeholder", default: "Regexp test result will appear here") %></p>

    <% elsif regular_expression.unready? %>
      <p class="text-gray-400 text-sm"><%= t("regular_expressions.results.please_enter", default: "Please enter a regex pattern and a test string.") %></p>

    <% elsif !regular_expression.valid? %>
      <label class="text-sm font-bold text-white"><%= t("regular_expressions.results.match_result_label", default: "Match result:") %></label>
      <div class="bg-red-100 border-4 border-double border-red-600 text-red-800 p-4 rounded-md font-semibold whitespace-pre-wrap mb-2">
        <%= t("regular_expressions.results.invalid_regex", default: "Invalid regular expression.") %>
      </div>

    <% elsif regular_expression.match_success %>
      <%= render "regular_expressions/results/match", regular_expression: regular_expression %>

      <% if regular_expression.display_captures.any? { |group| group.present? } %>
        <%= render "regular_expressions/results/capture", regular_expression: regular_expression %>
      <% end %>

      <% if regular_expression.substitution_result.present? %>
        <%= render "regular_expressions/results/substitution", regular_expression: regular_expression %>
      <% end %>

      <% if regular_expression.ruby_code.present? %>
        <%= render "regular_expressions/results/ruby_code", regular_expression: regular_expression %>
      <% end %>

      <%# If any errors were added during rendering (e.g. accessing multibyte named captures), show them here so the user sees a friendly message instead of a silent failure. %>
      <%# Only show non-diagram errors in the results area. Diagram-specific errors are shown beside the diagram. %>
      <% non_diagram_messages = regular_expression.errors.messages.except(:diagram).values.flatten %>
      <% if non_diagram_messages.any? %>
        <div class="bg-red-100 border-4 border-double border-red-600 text-red-800 p-4 rounded-md font-semibold whitespace-pre-wrap mb-2 mt-2">
          <% safe_messages = non_diagram_messages.map { |m| m.to_s.encode("UTF-8", invalid: :replace, undef: :replace, replace: "?") }.join("\n") %>
          <%= h(safe_messages) %>
        </div>
      <% end %>

    <% else %>
      <label class="text-sm font-bold text-white"><%= t("regular_expressions.results.match_result_label", default: "Match result:") %></label>
      <div class="bg-red-100 border-4 border-double border-red-600 text-red-800 p-4 rounded-md font-semibold whitespace-pre-wrap mb-2"><%= t("regular_expressions.results.no_matches", default: "No matches.") %></div>
    <% end %>
  </div>
</div>
